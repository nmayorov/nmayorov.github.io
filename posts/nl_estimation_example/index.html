<!doctype html><html lang=en><head><title>Solving a nonlinear estimation problem by optimization · My Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=description content="Here I want to demonstrate how the proposed nonlinear estimation algorithm solves an example estimation problem.
Model formulation Link to heading As a dynamics system for variable $y$ I consider a nonlinear damped oscillator with an external force $a$: $$ \ddot{y} + 2 \eta \omega \dot{y} (1 + \xi \dot{y}^2) + \omega^2 \sin y = a $$ The difference from the linear model are:
The returning force is changed from $y$ to $\sin y$ &ndash; this can be viewed as abandoning the small angle approximation for a gravity pendulum The friction force now nonlinear with an additional factor of $1 + \xi \dot{y}^2$ &ndash; the friction increases for high speed Introducing the variables $$ x_1 \coloneqq y \\ x_2 \coloneqq \dot{y} \\ $$ we rewrite it as a first order system $$ \dot{x_1} = x_2 \\ \dot{x_2} = -\omega^2 \sin x_1 - 2 \eta \omega x_2 (1 + \xi x_2^2) + a $$ Introduce discrete time variables $$ x_k \coloneqq x(k \tau) \\ a_k \coloneqq a(k \tau) $$ Applying the first-order integration method we get the following discrete time equation: $$ x_{k + 1} = f(x_k, a_k) \\ \text{with }f(x, f) = \begin{bmatrix} x_1 + \tau x_2 \\ x_2 - \tau (\omega^2 \sin x_1 + 2 \eta \omega x_2 (1 + \xi x_2^2) + f) \end{bmatrix} $$ Let&rsquo;s introduce the noise sources into it:"><meta name=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Solving a nonlinear estimation problem by optimization"><meta name=twitter:description content="Here I want to demonstrate how the proposed nonlinear estimation algorithm solves an example estimation problem.
Model formulation Link to heading As a dynamics system for variable $y$ I consider a nonlinear damped oscillator with an external force $a$: $$ \ddot{y} + 2 \eta \omega \dot{y} (1 + \xi \dot{y}^2) + \omega^2 \sin y = a $$ The difference from the linear model are:
The returning force is changed from $y$ to $\sin y$ &ndash; this can be viewed as abandoning the small angle approximation for a gravity pendulum The friction force now nonlinear with an additional factor of $1 + \xi \dot{y}^2$ &ndash; the friction increases for high speed Introducing the variables $$ x_1 \coloneqq y \\ x_2 \coloneqq \dot{y} \\ $$ we rewrite it as a first order system $$ \dot{x_1} = x_2 \\ \dot{x_2} = -\omega^2 \sin x_1 - 2 \eta \omega x_2 (1 + \xi x_2^2) + a $$ Introduce discrete time variables $$ x_k \coloneqq x(k \tau) \\ a_k \coloneqq a(k \tau) $$ Applying the first-order integration method we get the following discrete time equation: $$ x_{k + 1} = f(x_k, a_k) \\ \text{with }f(x, f) = \begin{bmatrix} x_1 + \tau x_2 \\ x_2 - \tau (\omega^2 \sin x_1 + 2 \eta \omega x_2 (1 + \xi x_2^2) + f) \end{bmatrix} $$ Let&rsquo;s introduce the noise sources into it:"><meta property="og:title" content="Solving a nonlinear estimation problem by optimization"><meta property="og:description" content="Here I want to demonstrate how the proposed nonlinear estimation algorithm solves an example estimation problem.
Model formulation Link to heading As a dynamics system for variable $y$ I consider a nonlinear damped oscillator with an external force $a$: $$ \ddot{y} + 2 \eta \omega \dot{y} (1 + \xi \dot{y}^2) + \omega^2 \sin y = a $$ The difference from the linear model are:
The returning force is changed from $y$ to $\sin y$ &ndash; this can be viewed as abandoning the small angle approximation for a gravity pendulum The friction force now nonlinear with an additional factor of $1 + \xi \dot{y}^2$ &ndash; the friction increases for high speed Introducing the variables $$ x_1 \coloneqq y \\ x_2 \coloneqq \dot{y} \\ $$ we rewrite it as a first order system $$ \dot{x_1} = x_2 \\ \dot{x_2} = -\omega^2 \sin x_1 - 2 \eta \omega x_2 (1 + \xi x_2^2) + a $$ Introduce discrete time variables $$ x_k \coloneqq x(k \tau) \\ a_k \coloneqq a(k \tau) $$ Applying the first-order integration method we get the following discrete time equation: $$ x_{k + 1} = f(x_k, a_k) \\ \text{with }f(x, f) = \begin{bmatrix} x_1 + \tau x_2 \\ x_2 - \tau (\omega^2 \sin x_1 + 2 \eta \omega x_2 (1 + \xi x_2^2) + f) \end{bmatrix} $$ Let&rsquo;s introduce the noise sources into it:"><meta property="og:type" content="article"><meta property="og:url" content="https://nmayorov.github.io/posts/nl_estimation_example/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-06T00:00:00+00:00"><meta property="article:modified_time" content="2022-12-06T00:00:00+00:00"><link rel=canonical href=https://nmayorov.github.io/posts/nl_estimation_example/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.c4d7e93a158eda5a65b3df343745d2092a0a1e2170feeec909b8a89443903c6a.css integrity="sha256-xNfpOhWO2lpls980N0XSCSoKHiFw/u7JCbiolEOQPGo=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.107.0"></head><body class="preload-transitions colorscheme-light"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>My Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Posts</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://nmayorov.github.io/posts/nl_estimation_example/>Solving a nonlinear estimation problem by optimization</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2022-12-06T00:00:00Z>December 6, 2022</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
6-minute read</span></div></div></header><div><p>Here I want to demonstrate how the <a href=https://nmayorov.github.io/posts/nonlinear_batch_estimation/>proposed nonlinear estimation algorithm</a> solves an example estimation problem.</p><h1 id=model-formulation>Model formulation
<a class=heading-link href=#model-formulation><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>As a dynamics system for variable $y$ I consider a nonlinear damped oscillator with an external force $a$:
$$
\ddot{y} + 2 \eta \omega \dot{y} (1 + \xi \dot{y}^2) + \omega^2 \sin y = a
$$
The difference from the <a href=https://nmayorov.github.io/posts/verify_smoother/#model-formulation>linear model</a> are:</p><ul><li>The returning force is changed from $y$ to $\sin y$ &ndash; this can be viewed as abandoning the small angle approximation for a gravity pendulum</li><li>The friction force now nonlinear with an additional factor of $1 + \xi \dot{y}^2$ &ndash; the friction increases for high speed</li></ul><p>Introducing the variables
$$
x_1 \coloneqq y \\
x_2 \coloneqq \dot{y} \\
$$
we rewrite it as a first order system
$$
\dot{x_1} = x_2 \\
\dot{x_2} = -\omega^2 \sin x_1 - 2 \eta \omega x_2 (1 + \xi x_2^2) + a
$$
Introduce discrete time variables
$$
x_k \coloneqq x(k \tau) \\
a_k \coloneqq a(k \tau)
$$
Applying the first-order integration method we get the following discrete time equation:
$$
x_{k + 1} = f(x_k, a_k) \\
\text{with }f(x, f) = \begin{bmatrix}
x_1 + \tau x_2 \\
x_2 - \tau (\omega^2 \sin x_1 + 2 \eta \omega x_2 (1 + \xi x_2^2) + f)
\end{bmatrix}
$$
Let&rsquo;s introduce the noise sources into it:</p><ul><li>Assume that $\omega$ randomly varies from epoch to epoch, i. e. use $\omega + w_1$ in place $\omega$</li><li>Assume that $\eta$ randomly varies from epoch to epoch, i. e. use $\eta + w_2$ in place of $\eta$</li><li>Assume that the external force is a random white sequence, denote it by $w_3$</li></ul><p>Then we have the following stochastic function
$$
f(x, w) = \begin{bmatrix}
x_1 + \tau x_2 \\
x_2 - \tau ((\omega + w_1)^2 \sin x_1 + 2 (\eta + w_2) (\omega + w_1) x_2 (1 + \xi x_2^2) + w_3)
\end{bmatrix}
$$
Such $f$ has nonlinearities in both state and noise which is good for evaluating the method.</p><p>Let&rsquo;s compute the Jacobian of $f$ with respect to $x$ and $w$:
$$
F = \frac{\partial f}{\partial x} = \begin{bmatrix}
1 & \tau \\
-\tau (\omega + w_1)^2 \cos x_1 & 1 - 2 \tau (\eta + w_2) (\omega + w_1) (1 + 3 \xi x_2^2) \\
\end{bmatrix} \\
G = \frac{\partial f}{\partial w} = \begin{bmatrix}
0 & 0 & 0 \\
-2 \tau ((\omega + w_1) \sin x_1 + (\eta + w_2) x_2 (1 + \xi x_2^2)) & -2 \tau (\omega + w_1) x_2 (1 + \xi x_2^2) & \tau
\end{bmatrix}
$$</p><p>For the measurements let&rsquo;s assume the following model:
$$
z = \sin x_1 + v
$$
This can be interpreted as measuring $y$ coordinate of a gravity pendulum.</p><p>Knowledge on prior statistics on $x_0$ is also available:
$$
\operatorname{E} x_0 = x_0^- \\
\operatorname{E} (x_0 - x_0^-)(x_0 - x_0^-)^T = P_0^-
$$</p><h1 id=numerical-values>Numerical values
<a class=heading-link href=#numerical-values><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>Here the numerical values used for the simulation are provided.
We assume that $x_1$ is measured in radians and $x_2$ in radians per second.</p><p>Model constants:</p><ul><li>$\omega = \dfrac{2 \pi}{10}$ Hz</li><li>$\eta = 0.5$</li><li>$\xi = 1 \text{ s}^2$</li><li>$\tau = 0.1 \text{ s}$</li></ul><p>Process noise covariance:
$$
Q = \begin{bmatrix}
(0.1 \text{ rad/s})^2 & 0 & 0 \\
0 & 0.01^2 & 0 \\
0 & 0 & (0.5 \text{ rad/s}^2)^2
\end{bmatrix}
$$
Measurement noise covariance:
$$
R = \begin{bmatrix}
0.1^2
\end{bmatrix}
$$
Prior mean and covariance:
$$
x_0^- = \begin{bmatrix}
\pi / 2 \text{ rad} \\
0 \text { rad/s}
\end{bmatrix} \\
P_0^- = \begin{bmatrix}
(0.1 \text{ rad})^2 & 0 \\
0 & (0.05 \text{ rad/s})^2
\end{bmatrix}
$$</p><p>The estimation is run over 1000 epochs with <a href=https://nmayorov.github.io/posts/nonlinear_batch_estimation/#termination>tolerance parameters</a> $t_c = t_f = 10^{-8}$ for the optimization.</p><h1 id=algorithms-results>Algorithm&rsquo;s results
<a class=heading-link href=#algorithms-results><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>Below the algorithm&rsquo;s metrics by iterations are shown (in log scale for y-axis).</p><p><a href=figs/metrics.svg><img src=figs/metrics.svg alt=metrics></a></p><p>The depicted variables have the following meaning:</p><ul><li>&ldquo;Prior cost&rdquo; &ndash; part of the cost function which accounts for the prior statistics on $x_0$</li><li>&ldquo;Measurement cost&rdquo; &ndash; part of the cost function which accounts for the measurement residuals</li><li>&ldquo;Noise cost&rdquo; &ndash; part of the cost function which accounts for the noise magnitude</li><li>&ldquo;Total cost&rdquo; &ndash; value of the total cost function</li><li>&ldquo;Constraints l1-norm&rdquo; &ndash; l1-norm of the time transition equation residuals (summed over all epochs)</li></ul><p>The solution at iteration 0 is the EKF solution: it has the lowest cost function (zero prior and noise costs), but doesn&rsquo;t at all satisfies time transition equations.
After 1 iteration the cost function almost reaches its optimal value.
Further iterations steadily reduce the constraints violation, which improves the solution smoothness.</p><p>In this problem 1 iteration, which corresponds to one smoother iteration (sort of &#171;Extended Kalman Smoother&#187;), gives a solution very close to the optimal and quite smooth.
But it is generally not guaranteed and the optimization approach gives a proper way to reason about convergence and estimation quality.</p><p>Values of $\mu$ used in the <a href=https://nmayorov.github.io/posts/nonlinear_batch_estimation/#merit-function-and-line-search>merit function</a> by iteration are depicted below</p><p><a href=figs/mu.svg><img src=figs/mu.svg alt=mu></a></p><p>We can see that $\mu$ is increased when necessary as explained in the other post.</p><p>Below the estimated and true values of state variables are depicted.
The plots in the second row enlarges the end part of the plots in the first row.</p><p><a href=figs/state.svg><img src=figs/state.svg alt=state></a></p><p>The estimates obtained by the optimization are smooth and qualitatively more accurate that the EKF estimates.</p><p>The estimated error standard deviations are depicted below.</p><p><a href=figs/sd.svg><img src=figs/sd.svg alt=state></a></p><p>We observe already known from the <a href=https://nmayorov.github.io/posts/verify_smoother/#comparison-of-sample-RMS-and-estimated-SD>linear case</a> relation between filter and smoother standard deviations.</p><p>Monte-Carlo simulation can and should be done to compare sample RMS and estimated SD of filter and optimization solutions.
It won&rsquo;t be included in this post however.</p><h1 id=relation-between-ekf-and-optimized-solutions>Relation between EKF and optimized solutions
<a class=heading-link href=#relation-between-ekf-and-optimized-solutions><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>We see that EKF solution has a low value of the cost function, but neglects the constraints (state time transition equations).
As the result the estimates don&rsquo;t have any smoothness properties: they are perturbed by the noisy measurements and don&rsquo;t satisfy the time transition equations.
From the optimization perspective the EKF solution is simply infeasible, i.e. it&rsquo;s not considered as a proper solution to the optimization problem.</p><p>The optimization algorithm &#171;smooths&#187; the EKF solution, with each iteration reducing the residual in the state transition equations.
In the process the cost function increases (due to nonzero noise estimates), but it is necessary to satisfy the problem constraints.</p><h1 id=conclusion>Conclusion
<a class=heading-link href=#conclusion><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>A solution to the batch nonlinear estimation problem as optimization was demonstrated and compared to the EKF solution.
It proved that the optimization is valid and efficient approach for solving nonlinear estimation problems.</p></div><footer></footer></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})'></script></section></div><footer class=footer><section class=container>©
2022
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.236049395dc3682fb2719640872958e12f1f24067bb09c327b233e6290c7edac.js integrity="sha256-I2BJOV3DaC+ycZZAhylY4S8fJAZ7sJwyeyM+YpDH7aw="></script></body></html>